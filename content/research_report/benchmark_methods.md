---
jupytext:
  text_representation:
    extension: .md
    format_name: myst
    format_version: 0.13
    jupytext_version: 1.14.1
kernelspec:
  display_name: Python 3
  language: python
  name: python3
---

# Benchmark methods

## Datasets

Dataset `ds000228` (N = 155) contains fMRI scans of participants watching a silent version of a Pixar animated movie "Partly Cloudy".
The dataset includes 33 adult subjects
(Age Mean(s.d.) =  24.8(5.3), range = 18--39; 20 female)
and 122 children subjects
(Age Mean(s.d.) =  6.7(2.3), range = 3.5--12.3; 64 female).
For more information on the dataset please refer to {cite:t}`richardson_development_2018`.

```{code-cell}
:tags: [hide-input]

import warnings

warnings.filterwarnings('ignore')
import pandas as pd
from myst_nb import glue
from fmriprep_denoise.visualization import tables, utils

path_root = utils.get_data_root() / "denoise-metrics"
fmriprep_version = 'fmriprep-20.2.1lts'

desc = tables.lazy_demographic('ds000228', fmriprep_version, path_root)
desc = desc.style.set_table_attributes('style="font-size: 12px"')

glue('ds000228_desc', desc)
```

Dataset `ds000030` includes multiple tasks collected from subjects with a variety of neuropsychiatric diagnosis , including ADHD, bipolar disorder, schizophrenia, and healthy controls.
The current analysis focused on the resting-state scans only.
Scans with an instrumental artifact (flagged under column `ghost_NoGhost` in `participants.tsv`) were excluded from the analysis pipeline.
Of 272 subjects, 212 entered the preprocessing stage.
Demographic information per condition can be found in {numref}`table-ds000030`.

```{table} Demographic information of ds000030
:name: table-ds000030
|                 | Full sample | Healthy control | Schizophrenia | Bipolar disorder |     ADHD    |
|----------------:|------------:|----------------:|--------------:|-----------------:|------------:|
|       N(female) |     212(98) |         106(54) |         30(8) |           41(19) |      35(17) |
|  Age Mean(s.d.) |   33.2(9.3) |       31.8(8.9) |    37.2 (9.2) |       34.7 (8.9) | 32.5 (10.2) |
|       Age Range |      21--50 |          21--50 |        22--49 |           21--50 |      21--50 |
```

```{code-cell}
:tags: [hide-input]

desc = tables.lazy_demographic('ds000030', fmriprep_version, path_root)
desc = desc.style.set_table_attributes('style="font-size: 12px"')

glue('ds000030_desc', desc)
```

## fMRI data preprocessing

We preprocessed fMRI data using fMRIPrep LTS20.2.1 through [`fMRIPrep-slurm`](https://github.com/SIMEXP/fmriprep-slurm) with the following options:
```
--use-aroma \
--omp-nthreads 1 \
--nprocs 1 \
--output-spaces MNI152NLin2009cAsym MNI152NLin6Asym \
--output-layout bids \
--notrack \
--skip_bids_validation \
--write-graph \
--resource-monitor
```

For the full description generated by fMRIPrep, please see [supplemental material](../supplementary_materials/CITATION.md).

## Choice of atlases

We extracted time series with regions of interest (ROI) defined by the following atlases:
Gordon atlas {cite:p}`gordon_atlas_2014`,
Schaefer 7 network atlas {cite:p}`schaefer_local-global_2017`,
Multiresolution Intrinsic Segmentation Template (MIST) {cite:p}`urchs_mist_2019`,
and Dictionary of Functional Modes (DiFuMo){cite:p}`difumo_2020`.
All atlases were resampled to the resolution of the preprocessed functional data.

````{margin}
```{admonition} Warning message related to masker resampling
:class: note
[See source code](https://github.com/nilearn/nilearn/blob/d53169c6af1cbb3db3485c9480a3e7cb31c2537d/nilearn/maskers/nifti_labels_masker.py#L568-L573)
```
````

Since DiFuMo and MIST atlases can include networks with disjointed regions under the same label, 
we carried out further ROI extraction. 
Labels are presented with the original number of parcels.
and we denote the number of extracted ROI in brackets. 
Gordon and Schaefer atlas parcels use isolated ROI, 
hence no further extraction was done. 
The Schaefer 1000 parcels atlas was excluded since some regions would disappear after resampling the atlas to the shape of the processed fMRI data. 

- Gordon atlas: 333
- Schaefer atlas: 100, 200, 300, 400, 500, 600, 800
- Multiresolution Intrinsic Segmentation Template (MIST) {cite:p}`urchs_mist_2019`: 7, 12, 20, 36, 64, 122, 197, 325, 444, "ROI" (210 parcels, 122 split by the midline)
- DiFuMo atlas {cite:p}`difumo_2020`: 64 (114), 128 (200), 256 (372), 512 (637), 1024 (1158)

Processes involved here are implemented through nilearn {cite:p}`nilearn`.
Time series were extracted using `nilearn.maskers.NiftiLabelsMasker` and `nilearn.maskers.NiftiMapsMasker`.
Connectomes were calculated using Pearson's Correlation, implemented through `nilearn.connectome.ConnectivityMeasure`.

(framewise-displacement)=
## Participant exclusion based on motion

We performed data quality control to exclude subjects with excessive motion leading to unusable data.
In the current report, we use framewise displacement as the metric to quantify motion. 
Framewise displacement indexes the movement of the head from one volume to the next.
The movement includes the transitions on the three axes ($x$, $y$, $z$) and the respective rotation ($\alpha$, $\beta$, $\gamma$).
Rotational displacements are calculated as the displacement on the surface of a sphere of radius 50 mm {cite}`power_scrubbing_2012`.
fMRIPrep generates the dramewise displacement based on the formula proposed in {cite}`power_scrubbing_2012`.
The framewise displacement, denoted as FD, at each time point $t$ is expressed as:

$$
\text{FD}_t = |\Delta d_{x,t}| + |\Delta d_{y,t}| +
|\Delta d_{z,t}| + |\Delta \alpha_t| + |\Delta \beta_t| + |\Delta \gamma_t|
$$

```{code-cell}
:tags: [hide-input, remove-output]
from fmriprep_denoise.features.derivatives import get_qc_criteria

stringent = get_qc_criteria('stringent')
glue('gross_fd', stringent['gross_fd'])
glue('fd_thresh', stringent['fd_thresh'])
glue('proportion_thresh', stringent['proportion_thresh'] * 100)
```

To ensure the analysis is performed in a realistic scenario we exclude subjects with high motion, 
defined by the following criteria adopted from  {cite:p}`parkes_evaluation_2018`: 
mean framewise displacement > {glue:}`gross_fd` mm, 
above {glue:}`proportion_thresh`% of volumes removed while scrubbing 
with a {glue:}`fd_thresh` mm threshold.

## Confound regression strategies

Confound variables were retrieved using 
(i) a basic API that retrieves different classes of confound regressors,
`nilearn.interfaces.fmriprep.load_confounds` (simplified as `load_confounds`);
and (ii) a higher level wrapper to implement common strategies from the denoising literature,
`nilearn.interfaces.fmriprep.load_confounds_strategy`(simplified as `load_confounds_strategy`).
The following section describes the logic behind the design of the API.
For documentation of the actual function, please see the latest version of [`nilearn` documentation](https://nilearn.github.io/stable/). 

We evaluated common confound regression strategies that are possible through fMRIPrep-generated confound regressors.
The connectome generated from high-pass filtered time series served as a baseline comparison.
Confound variables were accessed using the API `load_confounds_strategy`.
The detailed 11 strategies and a full breakdown of parameters used under the hood is presented in {numref}`table-examined_strategies`.

:::{dropdown} Click to see {numref}`table-examined_strategies`

```{table} Denoising strategies
:name: table-examined_strategies
| strategy        | image                          | `high_pass` | `motion` | `wm_csf` | `global_signal` | `scrub` | `fd_thresh` | `compcor`       | `n_compcor` | `ica_aroma` | `demean` |
|-----------------|--------------------------------|-------------|----------|----------|-----------------|---------|-------------|-----------------|-------------|-------------|----------|
| baseline        | `desc-preproc_bold`            | `True`      | N/A      | N/A      | N/A             | N/A     | N/A         | N/A             | N/A         | N/A         | `True`   |
| simple          | `desc-preproc_bold`            | `True`      | `full`   | `basic`  | N/A             | N/A     | N/A         | N/A             | N/A         | N/A         | `True`   |
| simple+gsr      | `desc-preproc_bold`            | `True`      | `full`   | `basic`  | `basic`         | N/A     | N/A         | N/A             | N/A         | N/A         | `True`   |
| scrubbing.5     | `desc-preproc_bold`            | `True`      | `full`   | `full`   | N/A             | `5`     | `0.5`       | N/A             | N/A         | N/A         | `True`   |
| scrubbing.5+gsr | `desc-preproc_bold`            | `True`      | `full`   | `full`   | `basic`         | `5`     | `0.5`       | N/A             | N/A         | N/A         | `True`   |
| scrubbing.2     | `desc-preproc_bold`            | `True`      | `full`   | `full`   | N/A             | `5`     | `0.2`       | N/A             | N/A         | N/A         | `True`   |
| scrubbing.2+gsr | `desc-preproc_bold`            | `True`      | `full`   | `full`   | `basic`         | `5`     | `0.2`       | N/A             | N/A         | N/A         | `True`   |
| compcor         | `desc-preproc_bold`            | `True`      | `full`   | N/A      | N/A             | N/A     | N/A         | `anat_combined` | `all`       | N/A         | `True`   |
| compcor6        | `desc-preproc_bold`            | `True`      | `full`   | N/A      | N/A             | N/A     | N/A         | `anat_combined` | `6 `        | N/A         | `True`   |
| aroma           | `desc-smoothAROMAnonaggr_bold` | `True`      | N/A      | `basic`  | N/A             | N/A     | N/A         | N/A             | N/A         | `full`      | `True`   |
| aroma+gsr       | `desc-smoothAROMAnonaggr_bold` | `True`      | N/A      | `basic`  | `basic`         | N/A     | N/A         | N/A             | N/A         | `full`      | `True`   |
```
:::

## Evaluation of the outcome of denoising strategies

We used selected metrics described in the previous literature to evaluate the denoising results
{cite:p}`ciric_benchmarking_2017,parkes_evaluation_2018`.

### Loss in temporal degrees of freedom

The common analysis and denoising methods are based on linear regression.
Using more nuisance regressors can capture additional sources of noise-related variance in the data and thus improve denoising.
However, this comes at the expense of a loss of temporal degrees of freedom for statistical inference in further analysis.
This is an important point to consider alongside the denoising performance.
There are two factors constraining the degrees of freedom in the signal: 
the number of volumes in a scan,
and the number of nuisance regressors used during denoising. 
We calculate the number of regressors used for each strategy.
For the scrubbing-based strategy we further calculate the proportion of volume loss to number of volumes in a scan.

### Quality control / functional connectivity (QC-FC)

QC-FC {cite:p}`power_recent_2015` quantifies the correlation between mean framewise displacement and functional connectivity.
This is calculated by a partial correlation between mean framewise displacement and connectivity,
with age and sex as covariates.
The denoising methods should aim to reduce the QC-FC value.
Significance values were corrected for multiple comparisons using the false positive rate.

### Distance-dependent effects of motion on connectivity

To determine the residual distance-dependence of subject movement,
we first calculated the Euclidean distance between the centers of mass of each pair of parcels {cite:p}`power_scrubbing_2012`.
We then correlated the distance separating each pair of parcels and the associated QC-FC correlation of the edge connecting those parcels.
Closer parcels generally exhibit greater impact of motion on connectivity.
We expect to see a general trend of negative to zero correlation after confound regression.

### Network modularity

Confound regressors have the potential to remove real signals in addition to motion-related noise.
In order to evaluate this possibility,
we computed modularity quality,
an explicit quantification of the degree to which there are structured sub-networks in a given network -
in this case the de-noised connectome {cite:p}`satterthwaite_impact_2012`.
Modularity quality is quantified by graph community detection based on the Louvain method {cite:p}`rubinov2010`,
implemented in the Brain Connectome Toolbox.
If confound regression and censoring were removing real signals in addition to motion-related noise,
we would expect modularity to decline.
To understand the extent of correlation between modularity and motion,
we computed the partial correlation between subjects' modularity values and mean framewise displacement,
with age and sex as covariates.

## Benchmark workflow

{numref}`fig-denoise-benchmark-workflow` presents the graphic summary of the benchmark workflow.

<!-- description TBA -->

```{figure} ../images/denoise-benchmark-workflow.png
---
height: 500px
name: fig-denoise-benchmark-workflow
---
Workflow of generating the full denoising benchmark.
```